import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ActivatedRoute, RouterModule } from '@angular/router';
import { UsersService } from '../users/users.service';
import { map, tap } from 'rxjs';
import { Schedule, User } from '../shared/auth.service';
import { FormsModule, ReactiveFormsModule, UntypedFormBuilder, Validators } from '@angular/forms';
import { SchedulesService } from './schedules.service';

@Component({
  selector: 'app-faculty-schedules',
  standalone: true,
  imports: [CommonModule, RouterModule, FormsModule, ReactiveFormsModule],
  templateUrl: './faculty-schedules.component.html',
  styles: [
  ]
})
export class FacultySchedulesComponent implements OnInit {
  users$ = this.user.getUsers();

  schedules$ = this.users$.pipe(
    tap(schedules => console.log(schedules))
  );

  filteredSchedules$ = this.schedules$.pipe(
    map((schedules: Schedule[]) => schedules?.filter((schedule: Schedule) => !schedule.is_deleted))
  );

  // Modal States
  createScheduleModalState: boolean = false;
  editScheduleModalState: boolean = false;
  archiveScheduleModalState: boolean = false;


  id: number = -1;
  selectedScheduleId: number = -1;

  form: any = {
    day: '',
    start_time: '',
    end_time: '',
    semester: '',
    section: '',
    subject: '',
    room: '',
  }
  constructor(private user: UsersService, private activatedRoute: ActivatedRoute, private formBulder: UntypedFormBuilder, private schedule: SchedulesService) { }

  ngOnInit(): void {
    this.activatedRoute.params.subscribe(params => {
      this.id = params['id'];
    });

    this.form = this.formBulder.group({
      day: ['', [Validators.required]],
      start_time: ['', [Validators.required]],
      end_time: ['', [Validators.required]],
      semester: ['', [Validators.required]],
      section: ['', [Validators.required]],
      subject: ['', [Validators.required]],
      room: ['', [Validators.required]],
    });

    this.user.init();
    this.user.init();
  }

  // Modal Functions

  // Create
  openCreateScheduleModal() {
    this.createScheduleModalState = true;
  }

  closeCreateScheduleModal() {
    this.createScheduleModalState = false;
  }

  onSubmitCreateSchedule() {
    if (this.form.invalid) return;

    this.schedule.createSchedule(this.id, this.form.value).subscribe((response: any) => {
      this.closeCreateScheduleModal();
      this.form.reset();
      this.user.init();
    });
  }

  // Edit
  openEditScheduleModal(scheduleId: number) {
    this.selectedScheduleId = scheduleId;
    this.editScheduleModalState = true;
  }

  closeEditScheduleModal() {
    this.selectedScheduleId = -1;
    this.editScheduleModalState = false;
  }

  // Archive
  openArchiveScheduleModal(scheduleId: number) {
    this.selectedScheduleId = scheduleId;
    this.archiveScheduleModalState = true;
  }

  closeArchiveScheduleModal() {
    this.selectedScheduleId = -1;
    this.archiveScheduleModalState = false;
  }

  print(event: any) {
    console.log(event.target.valueAsDate);
  }
}
